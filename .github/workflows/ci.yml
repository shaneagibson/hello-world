name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run Gitleaks Secret Scanning
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Run ktlint checks
      run: ./gradlew ktlintCheck

    - name: Run Detekt SAST
      run: ./gradlew detekt

    - name: Upload Detekt SARIF report
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: build/reports/detekt/detekt.sarif
        category: detekt

    - name: Run Semgrep SAST
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/kotlin
          p/owasp-top-ten

    - name: Run OWASP Dependency-Check
      run: ./gradlew dependencyCheckAnalyze
      env:
        NVD_API_KEY: ${{ secrets.NVD_API_KEY }}

    - name: Upload Dependency-Check report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-check-report
        path: build/reports/dependency-check-report.*
        retention-days: 30

    - name: Upload Dependency-Check SARIF
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: build/reports/dependency-check-report.sarif
        category: dependency-check

    - name: Generate License Report
      run: ./gradlew generateLicenseReport

    - name: Upload License Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: license-report
        path: build/reports/licenses/
        retention-days: 30

    - name: Build with Gradle
      run: ./gradlew build

    - name: Run tests
      run: ./gradlew test

    - name: Start application for API contract testing
      run: |
        java -jar build/libs/hello-world-0.0.1-SNAPSHOT.jar &
        APP_PID=$!
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
        # Wait for application to start
        timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health 2>/dev/null || curl -f http://localhost:8080/api-docs 2>/dev/null; do sleep 2; done'

    - name: Set up Python for Schemathesis
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Schemathesis
      run: pip install schemathesis

    - name: Run Schemathesis API Contract Tests
      run: |
        schemathesis run http://localhost:8080/api-docs \
          --checks all \
          --hypothesis-max-examples=50 \
          --hypothesis-deadline=5000 \
          --report

    - name: Stop application
      if: always()
      run: |
        if [ ! -z "$APP_PID" ]; then
          kill $APP_PID || true
        fi

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: hello-world-jar
        path: build/libs/*.jar
        retention-days: 30

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: build/test-results/
        retention-days: 30
